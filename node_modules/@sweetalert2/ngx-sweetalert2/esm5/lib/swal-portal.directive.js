import { __awaiter, __decorate, __generator, __param } from "tslib";
import { ApplicationRef, ComponentFactoryResolver, ComponentRef, Directive, Host, Injector, Input, OnDestroy, OnInit, TemplateRef } from '@angular/core';
import { Subject } from 'rxjs';
import { takeUntil } from 'rxjs/operators';
import { SwalPortalTarget, SwalPortalTargets } from './swal-portal-targets.service';
import { SwalPortalComponent } from './swal-portal.component';
import { SwalComponent } from './swal.component';
import { SweetAlert2LoaderService } from './sweetalert2-loader.service';
/**
 * A structural directive that lets you use Angular templates inside of SweetAlerts.
 * There are different targetable zones provided by {@link SwalPortalTargets}: title, content, confirmButton, etc, but
 * you can also make your own target by implementing {@link SwalPortalTarget} and giving it to this directive.
 * The default target is the alert text content zone.
 *
 * Usage in your component's TypeScript (if you use another target than {@link SwalPortalTargets.content}):
 *
 *     @Component({ ... })
 *     export class MyComponent {
 *         public constructor(public readonly swalTargets: SwalPortalTargets) {
 *         }
 *     }
 *
 * Usage in the template:
 *
 *     <swal title="Fill the form" (confirm)="confirmHandler()">
 *         <!-- This form will be displayed as the alert main content
 *              Targets the alert's main content zone by default -->
 *         <form *swalPortal [formControl]="myForm">
 *             ...
 *         </form>
 *
 *         <!-- This targets the confirm button's inner content
 *              Notice the usage of ng-container to avoid creating an useless DOM element inside the button -->
 *         <ng-container *swalPortal="swalTargets.confirmButton">
 *              Send ({{ secondsLeft }} seconds left)
 *         </ng-container>
 *     <swal>
 */
import * as ɵngcc0 from '@angular/core';
import * as ɵngcc1 from './sweetalert2-loader.service';
import * as ɵngcc2 from './swal-portal-targets.service';
import * as ɵngcc3 from './swal.component';
var SwalPortalDirective = /** @class */ (function () {
    function SwalPortalDirective(resolver, injector, app, templateRef, sweetAlert2Loader, swalTargets, swalComponent) {
        this.resolver = resolver;
        this.injector = injector;
        this.app = app;
        this.templateRef = templateRef;
        this.sweetAlert2Loader = sweetAlert2Loader;
        this.swalTargets = swalTargets;
        this.swalComponent = swalComponent;
        this.destroyed = new Subject();
    }
    /**
     * Subscribes to the the SweetAlert appearance/disappearance events to create/destroy the SwalPortalComponent
     * that will receive the consumer's template.
     */
    SwalPortalDirective.prototype.ngOnInit = function () {
        // Can't be set in a default property value, if the customer lets *swalPortal empty, the value we get is undef.
        this.target = this.target || this.swalTargets.content;
        //=> Apply the options provided by the target definition
        void this.swalComponent.update(this.target.options);
        //=> Subscribe to a few hooks frm the parent SwalComponent.
        this.swalComponent.render.pipe(takeUntil(this.destroyed)).subscribe(this.renderHook.bind(this));
        this.swalComponent.beforeOpen.pipe(takeUntil(this.destroyed)).subscribe(this.beforeOpenHook.bind(this));
        this.swalComponent.destroy.pipe(takeUntil(this.destroyed)).subscribe(this.destroyHook.bind(this));
    };
    /**
     * Signal any {@link destroyed} consumer that this is over, so they can unsubscribe from the
     * parent SwalComponent events.
     */
    SwalPortalDirective.prototype.ngOnDestroy = function () {
        this.destroyed.next();
    };
    /**
     * This render hook runs 1..n times (per modal instance), just before the modal is shown (and also before the
     * {@link beforeOpenHook}), or after Swal.update() is called.
     * This is a good place to render, or re-render, our portal contents.
     */
    SwalPortalDirective.prototype.renderHook = function () {
        return __awaiter(this, void 0, void 0, function () {
            var swal, targetEl;
            return __generator(this, function (_a) {
                switch (_a.label) {
                    case 0:
                        //=> Ensure the portal component is created
                        if (!this.portalComponentRef) {
                            this.portalComponentRef = this.createPortalComponent();
                        }
                        return [4 /*yield*/, this.sweetAlert2Loader.swal];
                    case 1:
                        swal = _a.sent();
                        targetEl = this.target.element(swal);
                        if (!targetEl)
                            return [2 /*return*/];
                        //=> Replace target's contents with our component
                        // https://jsperf.com/innerhtml-vs-removechild/15
                        while (targetEl.firstChild) {
                            targetEl.removeChild(targetEl.firstChild);
                        }
                        targetEl.appendChild(this.portalComponentRef.location.nativeElement);
                        return [2 /*return*/];
                }
            });
        });
    };
    /**
     * This beforeOpen hook runs once (per modal instance), just before the modal is shown on the screen.
     * This is a good place to declare our detached view to the Angular app.
     */
    SwalPortalDirective.prototype.beforeOpenHook = function () {
        if (!this.portalComponentRef)
            return;
        //=> Make the Angular app aware of that detached view so rendering and change detection can happen
        this.app.attachView(this.portalComponentRef.hostView);
    };
    /**
     * This afterClose hook runs once (per modal instance), just after the modal closing animation terminated.
     * This is a good place to detach and destroy our content, that is not visible anymore.
     */
    SwalPortalDirective.prototype.destroyHook = function () {
        if (!this.portalComponentRef)
            return;
        //=> Detach the portal component from the app and destroy it
        this.app.detachView(this.portalComponentRef.hostView);
        this.portalComponentRef.destroy();
        this.portalComponentRef = void 0;
    };
    /**
     * Creates the {@link SwalPortalComponent} and gives it the customer's template ref.
     */
    SwalPortalDirective.prototype.createPortalComponent = function () {
        //=> Create the SwalPortalComponent that will hold our content
        var factory = this.resolver.resolveComponentFactory(SwalPortalComponent);
        // Yes, we do not use the third argument that would directly use the target as the component's view
        // (unfortunately, because that would give a cleaner DOM and would avoid dirty and direct DOM manipulations)
        // That's because we want to keep our component safe from SweetAlert2's operations on the DOM, and to be
        // able to restore it at any moment, ie. after the modal has been re-rendered.
        var componentRef = factory.create(this.injector, []);
        //=> Apply the consumer's template on the component
        componentRef.instance.template = this.templateRef;
        return componentRef;
    };
    SwalPortalDirective.ctorParameters = function () { return [
        { type: ComponentFactoryResolver },
        { type: Injector },
        { type: ApplicationRef },
        { type: TemplateRef },
        { type: SweetAlert2LoaderService },
        { type: SwalPortalTargets },
        { type: SwalComponent, decorators: [{ type: Host }] }
    ]; };
    __decorate([
        Input('swalPortal')
    ], SwalPortalDirective.prototype, "target", void 0);
    SwalPortalDirective = __decorate([ __param(6, Host())
    ], SwalPortalDirective);
SwalPortalDirective.ɵfac = function SwalPortalDirective_Factory(t) { return new (t || SwalPortalDirective)(ɵngcc0.ɵɵdirectiveInject(ɵngcc0.ComponentFactoryResolver), ɵngcc0.ɵɵdirectiveInject(ɵngcc0.Injector), ɵngcc0.ɵɵdirectiveInject(ɵngcc0.ApplicationRef), ɵngcc0.ɵɵdirectiveInject(ɵngcc0.TemplateRef), ɵngcc0.ɵɵdirectiveInject(ɵngcc1.SweetAlert2LoaderService), ɵngcc0.ɵɵdirectiveInject(ɵngcc2.SwalPortalTargets), ɵngcc0.ɵɵdirectiveInject(ɵngcc3.SwalComponent, 1)); };
SwalPortalDirective.ɵdir = ɵngcc0.ɵɵdefineDirective({ type: SwalPortalDirective, selectors: [["", "swalPortal", ""]], inputs: { target: ["swalPortal", "target"] } });
/*@__PURE__*/ (function () { ɵngcc0.ɵsetClassMetadata(SwalPortalDirective, [{
        type: Directive,
        args: [{
                selector: '[swalPortal]'
            }]
    }], function () { return [{ type: ɵngcc0.ComponentFactoryResolver }, { type: ɵngcc0.Injector }, { type: ɵngcc0.ApplicationRef }, { type: ɵngcc0.TemplateRef }, { type: ɵngcc1.SweetAlert2LoaderService }, { type: ɵngcc2.SwalPortalTargets }, { type: ɵngcc3.SwalComponent, decorators: [{
                type: Host
            }] }]; }, { target: [{
            type: Input,
            args: ['swalPortal']
        }] }); })();
    return SwalPortalDirective;
}());
export { SwalPortalDirective };

//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic3dhbC1wb3J0YWwuZGlyZWN0aXZlLmpzIiwic291cmNlcyI6WyJAc3dlZXRhbGVydDIvbmd4LXN3ZWV0YWxlcnQyL2xpYi9zd2FsLXBvcnRhbC5kaXJlY3RpdmUudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IjtBQUFBLE9BQU8sRUFDSCxjQUFjLEVBQUUsd0JBQXdCLEVBQUUsWUFBWSxFQUFFLFNBQVMsRUFBRSxJQUFJLEVBQUUsUUFBUSxFQUFFLEtBQUssRUFBRSxTQUFTLEVBQUUsTUFBTSxFQUMzRyxXQUFXLEVBQ2QsTUFBTSxlQUFlLENBQUM7QUFDdkIsT0FBTyxFQUFFLE9BQU8sRUFBRSxNQUFNLE1BQU0sQ0FBQztBQUMvQixPQUFPLEVBQUUsU0FBUyxFQUFFLE1BQU0sZ0JBQWdCLENBQUM7QUFDM0MsT0FBTyxFQUFFLGdCQUFnQixFQUFFLGlCQUFpQixFQUFFLE1BQU0sK0JBQStCLENBQUM7QUFDcEYsT0FBTyxFQUFFLG1CQUFtQixFQUFFLE1BQU0seUJBQXlCLENBQUM7QUFDOUQsT0FBTyxFQUFFLGFBQWEsRUFBRSxNQUFNLGtCQUFrQixDQUFDO0FBQ2pELE9BQU8sRUFBRSx3QkFBd0IsRUFBRSxNQUFNLDhCQUE4QixDQUFDO0FBRXhFO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxHQUFHOzs7OztBQUlIO0FBQXVELElBZ0JuRCw2QkFDcUIsUUFBa0MsRUFDbEMsUUFBa0IsRUFDbEIsR0FBbUIsRUFDbkIsV0FBNkIsRUFDN0IsaUJBQTJDLEVBQzNDLFdBQThCLEVBQ3RCLGFBQTRCO0FBQzdELFFBUHlCLGFBQVEsR0FBUixRQUFRLENBQTBCO0FBQUMsUUFDbkMsYUFBUSxHQUFSLFFBQVEsQ0FBVTtBQUFDLFFBQ25CLFFBQUcsR0FBSCxH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aUMsUUFBUTtBQUN6QyxnQkFBNEIsY0FBYztBQUMxQyxnQkFBb0MsV0FBVztBQUFJLGdCQUNULHdCQUF3QjtBQUNsRSxnQkFBb0MsaUJBQWlCO0FBQ3JELGdCQUE4QyxhQUFhLHVCQUFwRCxJQUFJO0FBQU07QUFBVSxJQWhCSjtBQUFhLFFBQWpDLEtBQUssQ0FBQyxZQUFZLENBQUM7QUFBQyx1REFBaUM7QUFFMUQsSUFUYSxtQkFBbUIsd0JBSC9CLFNBQVMsQ0FBQyxuQkFHSCxDQXVCQyxXQUFBLElBQUksRUFBRSxDQUFBO2FBekJYLFFBQVEsRUFBRSx2QkF5QkUsT0F2QkgsbUJBQW1CLENBMkgvQjtRQTdIMkIsVUFDM0IsQ0FBQzs7Ozs7Ozs7Ozs7O29CQTZIRjtBQUFDLElBREQsMEJBQUM7QUFDQSxDQURBLEFBM0hELElBMkhDO0FBQ0QsU0E1SGEsbUJBQW1CO0FBQUkiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQge1xuICAgIEFwcGxpY2F0aW9uUmVmLCBDb21wb25lbnRGYWN0b3J5UmVzb2x2ZXIsIENvbXBvbmVudFJlZiwgRGlyZWN0aXZlLCBIb3N0LCBJbmplY3RvciwgSW5wdXQsIE9uRGVzdHJveSwgT25Jbml0LFxuICAgIFRlbXBsYXRlUmVmXG59IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuaW1wb3J0IHsgU3ViamVjdCB9IGZyb20gJ3J4anMnO1xuaW1wb3J0IHsgdGFrZVVudGlsIH0gZnJvbSAncnhqcy9vcGVyYXRvcnMnO1xuaW1wb3J0IHsgU3dhbFBvcnRhbFRhcmdldCwgU3dhbFBvcnRhbFRhcmdldHMgfSBmcm9tICcuL3N3YWwtcG9ydGFsLXRhcmdldHMuc2VydmljZSc7XG5pbXBvcnQgeyBTd2FsUG9ydGFsQ29tcG9uZW50IH0gZnJvbSAnLi9zd2FsLXBvcnRhbC5jb21wb25lbnQnO1xuaW1wb3J0IHsgU3dhbENvbXBvbmVudCB9IGZyb20gJy4vc3dhbC5jb21wb25lbnQnO1xuaW1wb3J0IHsgU3dlZXRBbGVydDJMb2FkZXJTZXJ2aWNlIH0gZnJvbSAnLi9zd2VldGFsZXJ0Mi1sb2FkZXIuc2VydmljZSc7XG5cbi8qKlxuICogQSBzdHJ1Y3R1cmFsIGRpcmVjdGl2ZSB0aGF0IGxldHMgeW91IHVzZSBBbmd1bGFyIHRlbXBsYXRlcyBpbnNpZGUgb2YgU3dlZXRBbGVydHMuXG4gKiBUaGVyZSBhcmUgZGlmZmVyZW50IHRhcmdldGFibGUgem9uZXMgcHJvdmlkZWQgYnkge0BsaW5rIFN3YWxQb3J0YWxUYXJnZXRzfTogdGl0bGUsIGNvbnRlbnQsIGNvbmZpcm1CdXR0b24sIGV0YywgYnV0XG4gKiB5b3UgY2FuIGFsc28gbWFrZSB5b3VyIG93biB0YXJnZXQgYnkgaW1wbGVtZW50aW5nIHtAbGluayBTd2FsUG9ydGFsVGFyZ2V0fSBhbmQgZ2l2aW5nIGl0IHRvIHRoaXMgZGlyZWN0aXZlLlxuICogVGhlIGRlZmF1bHQgdGFyZ2V0IGlzIHRoZSBhbGVydCB0ZXh0IGNvbnRlbnQgem9uZS5cbiAqXG4gKiBVc2FnZSBpbiB5b3VyIGNvbXBvbmVudCdzIFR5cGVTY3JpcHQgKGlmIHlvdSB1c2UgYW5vdGhlciB0YXJnZXQgdGhhbiB7QGxpbmsgU3dhbFBvcnRhbFRhcmdldHMuY29udGVudH0pOlxuICpcbiAqICAgICBAQ29tcG9uZW50KHsgLi4uIH0pXG4gKiAgICAgZXhwb3J0IGNsYXNzIE15Q29tcG9uZW50IHtcbiAqICAgICAgICAgcHVibGljIGNvbnN0cnVjdG9yKHB1YmxpYyByZWFkb25seSBzd2FsVGFyZ2V0czogU3dhbFBvcnRhbFRhcmdldHMpIHtcbiAqICAgICAgICAgfVxuICogICAgIH1cbiAqXG4gKiBVc2FnZSBpbiB0aGUgdGVtcGxhdGU6XG4gKlxuICogICAgIDxzd2FsIHRpdGxlPVwiRmlsbCB0aGUgZm9ybVwiIChjb25maXJtKT1cImNvbmZpcm1IYW5kbGVyKClcIj5cbiAqICAgICAgICAgPCEtLSBUaGlzIGZvcm0gd2lsbCBiZSBkaXNwbGF5ZWQgYXMgdGhlIGFsZXJ0IG1haW4gY29udGVudFxuICogICAgICAgICAgICAgIFRhcmdldHMgdGhlIGFsZXJ0J3MgbWFpbiBjb250ZW50IHpvbmUgYnkgZGVmYXVsdCAtLT5cbiAqICAgICAgICAgPGZvcm0gKnN3YWxQb3J0YWwgW2Zvcm1Db250cm9sXT1cIm15Rm9ybVwiPlxuICogICAgICAgICAgICAgLi4uXG4gKiAgICAgICAgIDwvZm9ybT5cbiAqXG4gKiAgICAgICAgIDwhLS0gVGhpcyB0YXJnZXRzIHRoZSBjb25maXJtIGJ1dHRvbidzIGlubmVyIGNvbnRlbnRcbiAqICAgICAgICAgICAgICBOb3RpY2UgdGhlIHVzYWdlIG9mIG5nLWNvbnRhaW5lciB0byBhdm9pZCBjcmVhdGluZyBhbiB1c2VsZXNzIERPTSBlbGVtZW50IGluc2lkZSB0aGUgYnV0dG9uIC0tPlxuICogICAgICAgICA8bmctY29udGFpbmVyICpzd2FsUG9ydGFsPVwic3dhbFRhcmdldHMuY29uZmlybUJ1dHRvblwiPlxuICogICAgICAgICAgICAgIFNlbmQgKHt7IHNlY29uZHNMZWZ0IH19IHNlY29uZHMgbGVmdClcbiAqICAgICAgICAgPC9uZy1jb250YWluZXI+XG4gKiAgICAgPHN3YWw+XG4gKi9cbkBEaXJlY3RpdmUoe1xuICAgIHNlbGVjdG9yOiAnW3N3YWxQb3J0YWxdJ1xufSlcbmV4cG9ydCBjbGFzcyBTd2FsUG9ydGFsRGlyZWN0aXZlIGltcGxlbWVudHMgT25Jbml0LCBPbkRlc3Ryb3kge1xuICAgIC8qKlxuICAgICAqIFRha2VzIGEgcG9ydGFsIHRhcmdldCBvciBub3RoaW5nICh0aGVuIGl0IHdpbGwgdGFyZ2V0IHRoZSB0ZXh0IGNvbnRlbnQgem9uZSBieSBkZWZhdWx0KS5cbiAgICAgKlxuICAgICAqIFNlZSB0aGUge0BsaW5rIFN3YWxQb3J0YWxUYXJnZXRzfSBzZXJ2aWNlIHRvIHNlZSB0aGUgYXZhaWxhYmxlIHRhcmdldHMuXG4gICAgICogU2VlIHRoZSBjbGFzcyBkb2MgYmxvY2sgZm9yIG1vcmUgaW5mb3JtYXRpb25zLlxuICAgICAqL1xuICAgIEBJbnB1dCgnc3dhbFBvcnRhbCcpIHB1YmxpYyB0YXJnZXQ/OiBTd2FsUG9ydGFsVGFyZ2V0O1xuXG4gICAgLyoqXG4gICAgICogSG9sZHMgdGhlIGNvbXBvbmVudCByZWZlcmVuY2Ugb2YgdGhlIGNvbnRyb2xsZWQgU3dhbFBvcnRhbENvbXBvbmVudCB0byBkZXN0cm95IGl0IHdoZW4gbm8gbG9uZ2VyIG5lZWRlZC5cbiAgICAgKi9cbiAgICBwcml2YXRlIHBvcnRhbENvbXBvbmVudFJlZj86IENvbXBvbmVudFJlZjxTd2FsUG9ydGFsQ29tcG9uZW50PjtcblxuICAgIHByaXZhdGUgcmVhZG9ubHkgZGVzdHJveWVkID0gbmV3IFN1YmplY3Q8dm9pZD4oKTtcblxuICAgIHB1YmxpYyBjb25zdHJ1Y3RvcihcbiAgICAgICAgcHJpdmF0ZSByZWFkb25seSByZXNvbHZlcjogQ29tcG9uZW50RmFjdG9yeVJlc29sdmVyLFxuICAgICAgICBwcml2YXRlIHJlYWRvbmx5IGluamVjdG9yOiBJbmplY3RvcixcbiAgICAgICAgcHJpdmF0ZSByZWFkb25seSBhcHA6IEFwcGxpY2F0aW9uUmVmLFxuICAgICAgICBwcml2YXRlIHJlYWRvbmx5IHRlbXBsYXRlUmVmOiBUZW1wbGF0ZVJlZjxhbnk+LFxuICAgICAgICBwcml2YXRlIHJlYWRvbmx5IHN3ZWV0QWxlcnQyTG9hZGVyOiBTd2VldEFsZXJ0MkxvYWRlclNlcnZpY2UsXG4gICAgICAgIHByaXZhdGUgcmVhZG9ubHkgc3dhbFRhcmdldHM6IFN3YWxQb3J0YWxUYXJnZXRzLFxuICAgICAgICBASG9zdCgpIHByaXZhdGUgcmVhZG9ubHkgc3dhbENvbXBvbmVudDogU3dhbENvbXBvbmVudCkge1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIFN1YnNjcmliZXMgdG8gdGhlIHRoZSBTd2VldEFsZXJ0IGFwcGVhcmFuY2UvZGlzYXBwZWFyYW5jZSBldmVudHMgdG8gY3JlYXRlL2Rlc3Ryb3kgdGhlIFN3YWxQb3J0YWxDb21wb25lbnRcbiAgICAgKiB0aGF0IHdpbGwgcmVjZWl2ZSB0aGUgY29uc3VtZXIncyB0ZW1wbGF0ZS5cbiAgICAgKi9cbiAgICBwdWJsaWMgbmdPbkluaXQoKTogdm9pZCB7XG4gICAgICAgIC8vIENhbid0IGJlIHNldCBpbiBhIGRlZmF1bHQgcHJvcGVydHkgdmFsdWUsIGlmIHRoZSBjdXN0b21lciBsZXRzICpzd2FsUG9ydGFsIGVtcHR5LCB0aGUgdmFsdWUgd2UgZ2V0IGlzIHVuZGVmLlxuICAgICAgICB0aGlzLnRhcmdldCA9IHRoaXMudGFyZ2V0IHx8IHRoaXMuc3dhbFRhcmdldHMuY29udGVudDtcblxuICAgICAgICAvLz0+IEFwcGx5IHRoZSBvcHRpb25zIHByb3ZpZGVkIGJ5IHRoZSB0YXJnZXQgZGVmaW5pdGlvblxuICAgICAgICB2b2lkIHRoaXMuc3dhbENvbXBvbmVudC51cGRhdGUodGhpcy50YXJnZXQub3B0aW9ucyk7XG5cbiAgICAgICAgLy89PiBTdWJzY3JpYmUgdG8gYSBmZXcgaG9va3MgZnJtIHRoZSBwYXJlbnQgU3dhbENvbXBvbmVudC5cbiAgICAgICAgdGhpcy5zd2FsQ29tcG9uZW50LnJlbmRlci5waXBlKHRha2VVbnRpbCh0aGlzLmRlc3Ryb3llZCkpLnN1YnNjcmliZSh0aGlzLnJlbmRlckhvb2suYmluZCh0aGlzKSk7XG4gICAgICAgIHRoaXMuc3dhbENvbXBvbmVudC5iZWZvcmVPcGVuLnBpcGUodGFrZVVudGlsKHRoaXMuZGVzdHJveWVkKSkuc3Vic2NyaWJlKHRoaXMuYmVmb3JlT3Blbkhvb2suYmluZCh0aGlzKSk7XG4gICAgICAgIHRoaXMuc3dhbENvbXBvbmVudC5kZXN0cm95LnBpcGUodGFrZVVudGlsKHRoaXMuZGVzdHJveWVkKSkuc3Vic2NyaWJlKHRoaXMuZGVzdHJveUhvb2suYmluZCh0aGlzKSk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogU2lnbmFsIGFueSB7QGxpbmsgZGVzdHJveWVkfSBjb25zdW1lciB0aGF0IHRoaXMgaXMgb3Zlciwgc28gdGhleSBjYW4gdW5zdWJzY3JpYmUgZnJvbSB0aGVcbiAgICAgKiBwYXJlbnQgU3dhbENvbXBvbmVudCBldmVudHMuXG4gICAgICovXG4gICAgcHVibGljIG5nT25EZXN0cm95KCk6IHZvaWQge1xuICAgICAgICB0aGlzLmRlc3Ryb3llZC5uZXh0KCk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogVGhpcyByZW5kZXIgaG9vayBydW5zIDEuLm4gdGltZXMgKHBlciBtb2RhbCBpbnN0YW5jZSksIGp1c3QgYmVmb3JlIHRoZSBtb2RhbCBpcyBzaG93biAoYW5kIGFsc28gYmVmb3JlIHRoZVxuICAgICAqIHtAbGluayBiZWZvcmVPcGVuSG9va30pLCBvciBhZnRlciBTd2FsLnVwZGF0ZSgpIGlzIGNhbGxlZC5cbiAgICAgKiBUaGlzIGlzIGEgZ29vZCBwbGFjZSB0byByZW5kZXIsIG9yIHJlLXJlbmRlciwgb3VyIHBvcnRhbCBjb250ZW50cy5cbiAgICAgKi9cbiAgICBwcml2YXRlIGFzeW5jIHJlbmRlckhvb2soKTogUHJvbWlzZTx2b2lkPiB7XG4gICAgICAgIC8vPT4gRW5zdXJlIHRoZSBwb3J0YWwgY29tcG9uZW50IGlzIGNyZWF0ZWRcbiAgICAgICAgaWYgKCF0aGlzLnBvcnRhbENvbXBvbmVudFJlZikge1xuICAgICAgICAgICAgdGhpcy5wb3J0YWxDb21wb25lbnRSZWYgPSB0aGlzLmNyZWF0ZVBvcnRhbENvbXBvbmVudCgpO1xuICAgICAgICB9XG5cbiAgICAgICAgLy89PiBTd2VldEFsZXJ0MiBjcmVhdGVkIHRoZSBtb2RhbCBvciBqdXN0IGVyYXNlZCBhbGwgb2Ygb3VyIGNvbnRlbnQsIHNvIHdlIG5lZWQgdG8gaW5zdGFsbC9yZWluc3RhbGwgaXQuXG4gICAgICAgIC8vIFN3YWwudXBkYXRlKCkgaXMgc3luY2hyb25vdXMsIHRoaXMgb2JzZXJ2YWJsZSB0b28sIGFuZCBtb3VudENvbXBvbmVudE9uVGFyZ2V0IHRvbyAodGhlIHByb21pc2UgaW5zaWRlXG4gICAgICAgIC8vIHRoaXMgZnVuY3Rpb24gaXMgYWxyZWFkeSByZXNvbHZlZCBhdCB0aGlzIHBvaW50KSwgc28gdGhlIHdob2xlIHByb2Nlc3Mgb2YgcmUtcmVuZGVyaW5nIGFuZCByZS1tb3VudGluZ1xuICAgICAgICAvLyB0aGUgcG9ydGFsIGNvbXBvbmVudCBpcyBmdWxseSBzeW5jaHJvbm91cywgY2F1c2luZyBubyBibGlua3MgaW4gdGhlIG1vZGFsIGNvbnRlbnRzLlxuICAgICAgICBjb25zdCBzd2FsID0gYXdhaXQgdGhpcy5zd2VldEFsZXJ0MkxvYWRlci5zd2FsO1xuXG4gICAgICAgIC8vPT4gRmluZCB0YXJnZXQgZWxlbWVudFxuICAgICAgICBjb25zdCB0YXJnZXRFbCA9IHRoaXMudGFyZ2V0IS5lbGVtZW50KHN3YWwpO1xuICAgICAgICBpZiAoIXRhcmdldEVsKSByZXR1cm47XG5cbiAgICAgICAgLy89PiBSZXBsYWNlIHRhcmdldCdzIGNvbnRlbnRzIHdpdGggb3VyIGNvbXBvbmVudFxuICAgICAgICAvLyBodHRwczovL2pzcGVyZi5jb20vaW5uZXJodG1sLXZzLXJlbW92ZWNoaWxkLzE1XG4gICAgICAgIHdoaWxlICh0YXJnZXRFbC5maXJzdENoaWxkKSB7XG4gICAgICAgICAgICB0YXJnZXRFbC5yZW1vdmVDaGlsZCh0YXJnZXRFbC5maXJzdENoaWxkKTtcbiAgICAgICAgfVxuXG4gICAgICAgIHRhcmdldEVsLmFwcGVuZENoaWxkKHRoaXMucG9ydGFsQ29tcG9uZW50UmVmLmxvY2F0aW9uLm5hdGl2ZUVsZW1lbnQpO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIFRoaXMgYmVmb3JlT3BlbiBob29rIHJ1bnMgb25jZSAocGVyIG1vZGFsIGluc3RhbmNlKSwganVzdCBiZWZvcmUgdGhlIG1vZGFsIGlzIHNob3duIG9uIHRoZSBzY3JlZW4uXG4gICAgICogVGhpcyBpcyBhIGdvb2QgcGxhY2UgdG8gZGVjbGFyZSBvdXIgZGV0YWNoZWQgdmlldyB0byB0aGUgQW5ndWxhciBhcHAuXG4gICAgICovXG4gICAgcHJpdmF0ZSBiZWZvcmVPcGVuSG9vaygpOiB2b2lkIHtcbiAgICAgICAgaWYgKCF0aGlzLnBvcnRhbENvbXBvbmVudFJlZikgcmV0dXJuO1xuXG4gICAgICAgIC8vPT4gTWFrZSB0aGUgQW5ndWxhciBhcHAgYXdhcmUgb2YgdGhhdCBkZXRhY2hlZCB2aWV3IHNvIHJlbmRlcmluZyBhbmQgY2hhbmdlIGRldGVjdGlvbiBjYW4gaGFwcGVuXG4gICAgICAgIHRoaXMuYXBwLmF0dGFjaFZpZXcodGhpcy5wb3J0YWxDb21wb25lbnRSZWYuaG9zdFZpZXcpO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIFRoaXMgYWZ0ZXJDbG9zZSBob29rIHJ1bnMgb25jZSAocGVyIG1vZGFsIGluc3RhbmNlKSwganVzdCBhZnRlciB0aGUgbW9kYWwgY2xvc2luZyBhbmltYXRpb24gdGVybWluYXRlZC5cbiAgICAgKiBUaGlzIGlzIGEgZ29vZCBwbGFjZSB0byBkZXRhY2ggYW5kIGRlc3Ryb3kgb3VyIGNvbnRlbnQsIHRoYXQgaXMgbm90IHZpc2libGUgYW55bW9yZS5cbiAgICAgKi9cbiAgICBwcml2YXRlIGRlc3Ryb3lIb29rKCk6IHZvaWQge1xuICAgICAgICBpZiAoIXRoaXMucG9ydGFsQ29tcG9uZW50UmVmKSByZXR1cm47XG5cbiAgICAgICAgLy89PiBEZXRhY2ggdGhlIHBvcnRhbCBjb21wb25lbnQgZnJvbSB0aGUgYXBwIGFuZCBkZXN0cm95IGl0XG4gICAgICAgIHRoaXMuYXBwLmRldGFjaFZpZXcodGhpcy5wb3J0YWxDb21wb25lbnRSZWYuaG9zdFZpZXcpO1xuICAgICAgICB0aGlzLnBvcnRhbENvbXBvbmVudFJlZi5kZXN0cm95KCk7XG4gICAgICAgIHRoaXMucG9ydGFsQ29tcG9uZW50UmVmID0gdm9pZCAwO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIENyZWF0ZXMgdGhlIHtAbGluayBTd2FsUG9ydGFsQ29tcG9uZW50fSBhbmQgZ2l2ZXMgaXQgdGhlIGN1c3RvbWVyJ3MgdGVtcGxhdGUgcmVmLlxuICAgICAqL1xuICAgIHByaXZhdGUgY3JlYXRlUG9ydGFsQ29tcG9uZW50KCk6IENvbXBvbmVudFJlZjxTd2FsUG9ydGFsQ29tcG9uZW50PiB7XG4gICAgICAgIC8vPT4gQ3JlYXRlIHRoZSBTd2FsUG9ydGFsQ29tcG9uZW50IHRoYXQgd2lsbCBob2xkIG91ciBjb250ZW50XG4gICAgICAgIGNvbnN0IGZhY3RvcnkgPSB0aGlzLnJlc29sdmVyLnJlc29sdmVDb21wb25lbnRGYWN0b3J5KFN3YWxQb3J0YWxDb21wb25lbnQpO1xuXG4gICAgICAgIC8vIFllcywgd2UgZG8gbm90IHVzZSB0aGUgdGhpcmQgYXJndW1lbnQgdGhhdCB3b3VsZCBkaXJlY3RseSB1c2UgdGhlIHRhcmdldCBhcyB0aGUgY29tcG9uZW50J3Mgdmlld1xuICAgICAgICAvLyAodW5mb3J0dW5hdGVseSwgYmVjYXVzZSB0aGF0IHdvdWxkIGdpdmUgYSBjbGVhbmVyIERPTSBhbmQgd291bGQgYXZvaWQgZGlydHkgYW5kIGRpcmVjdCBET00gbWFuaXB1bGF0aW9ucylcbiAgICAgICAgLy8gVGhhdCdzIGJlY2F1c2Ugd2Ugd2FudCB0byBrZWVwIG91ciBjb21wb25lbnQgc2FmZSBmcm9tIFN3ZWV0QWxlcnQyJ3Mgb3BlcmF0aW9ucyBvbiB0aGUgRE9NLCBhbmQgdG8gYmVcbiAgICAgICAgLy8gYWJsZSB0byByZXN0b3JlIGl0IGF0IGFueSBtb21lbnQsIGllLiBhZnRlciB0aGUgbW9kYWwgaGFzIGJlZW4gcmUtcmVuZGVyZWQuXG4gICAgICAgIGNvbnN0IGNvbXBvbmVudFJlZiA9IGZhY3RvcnkuY3JlYXRlKHRoaXMuaW5qZWN0b3IsIFtdKTtcblxuICAgICAgICAvLz0+IEFwcGx5IHRoZSBjb25zdW1lcidzIHRlbXBsYXRlIG9uIHRoZSBjb21wb25lbnRcbiAgICAgICAgY29tcG9uZW50UmVmLmluc3RhbmNlLnRlbXBsYXRlID0gdGhpcy50ZW1wbGF0ZVJlZjtcblxuICAgICAgICByZXR1cm4gY29tcG9uZW50UmVmO1xuICAgIH1cbn1cbiJdfQ==