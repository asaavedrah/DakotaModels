import { __decorate, __metadata } from "tslib";
import { OnDestroy, OnInit, OnChanges, EventEmitter, ElementRef, Input, Output, SimpleChanges, Directive, NgZone } from '@angular/core';
import * as Chart from 'chart.js';
import { StoreService } from './store.service';
import { NgChartjsService } from './ng-chartjs.service';
import { getColors } from './colors';
/* tslint:disable-next-line */
import * as ɵngcc0 from '@angular/core';
import * as ɵngcc1 from './ng-chartjs.service';
import * as ɵngcc2 from './store.service';
var NgChartjsDirective = /** @class */ (function () {
    function NgChartjsDirective(element, ngChartjsService, storeService, zone) {
        this.ngChartjsService = ngChartjsService;
        this.storeService = storeService;
        this.zone = zone;
        // x轴标签。这对图表来说是必要的：线，条和雷达。并且只是图表的标签（悬停）：polarArea，pie和doughnut
        this.labels = [];
        // 相当于chart.js的option
        this.options = {};
        this.noZone = true; // disable angular NgZone
        this.id = null; // chart instance id
        // 鼠标点击图表所有的区域
        this.chartClick = new EventEmitter();
        // 鼠标悬浮在标签或者活跃的点上面时
        this.chartHover = new EventEmitter();
        this.initFlag = false;
        this.hasChanges = false;
        this.element = element; // 获取指令所在canvas元素
    }
    NgChartjsDirective.prototype.ngOnInit = function () {
        var _this = this;
        this.ctx = this.element.nativeElement.getContext('2d'); // 获取元素的ctx
        this.initFlag = true; // 是否初始化了的标志
        if (this.data || this.datasets) { // 判断data和datasets有一个有数据就刷新
            if (this.noZone) {
                this.zone.runOutsideAngular(function () {
                    _this.refresh();
                });
            }
            else {
                this.refresh();
            }
        }
    };
    NgChartjsDirective.prototype.ngOnChanges = function (changes) {
        // TODO: 插件变化刷新，开放刷新按钮
        if (this.initFlag) {
            // Check if the changes are in the data or datasets
            if (changes.hasOwnProperty('data') || changes.hasOwnProperty('datasets')) {
                if (changes.data) {
                    this.updateChartData(changes.data.currentValue);
                }
                else {
                    this.updateChartData(changes.datasets.currentValue);
                }
                this.hasChanges = true;
            }
            if (changes.hasOwnProperty('labels')) {
                this.chart.data.labels = changes.labels.currentValue;
                this.hasChanges = true;
            }
            if (changes.hasOwnProperty('legend')) {
                if (changes.legend.currentValue !== changes.legend.previousValue) {
                    this.chart.options.legend.display = changes.legend.currentValue;
                    this.hasChanges = true;
                }
            }
            if (changes.hasOwnProperty('adding')) {
                this.addData_(changes.adding.currentValue.labels, changes.adding.currentValue.data);
                this.hasChanges = true;
            }
            if (changes.hasOwnProperty('removing')) {
                if (changes.removing.currentValue.orientation === 'oldest' || changes.removing.currentValue.orientation === 'latest') {
                    this.removeData_(changes.removing.currentValue.orientation);
                    this.hasChanges = true;
                }
            }
            if (changes.hasOwnProperty('chartType')) {
                this.refresh();
            }
            if (changes.hasOwnProperty('resetOption')) {
                Object.assign(this.chart.options, changes.resetOption.currentValue);
                this.hasChanges = true;
            }
            if (this.hasChanges) {
                this.chart.update();
                this.hasChanges = false;
            }
            // change chart id
            if (changes.hasOwnProperty('id')) {
                this.removeChart(changes.id.previousValue);
                this.addChart(changes.id.currentValue);
            }
        }
    };
    NgChartjsDirective.prototype.ngOnDestroy = function () {
        if (this.chart) {
            this.chart.destroy();
            this.chart = void 0;
            this.removeChart(this.id);
        }
    };
    // update chartjs
    NgChartjsDirective.prototype.update = function () {
        this.chart.update();
    };
    // Dynamic add data
    NgChartjsDirective.prototype.addData = function (labels, data) {
        this.addData_(labels, data);
        this.update();
    };
    // Dynamic remove data, orientation is 'ildest' or 'latest'
    NgChartjsDirective.prototype.removeData = function (orientation) {
        this.removeData_(orientation);
        this.update();
    };
    NgChartjsDirective.prototype.refresh = function () {
        this.ngOnDestroy();
        this.chart = this.getChartBuilder(this.ctx /*, data, this.options*/);
        this.addChart(this.id);
    };
    NgChartjsDirective.prototype.removeChart = function (id) {
        if (this.element.nativeElement.hasAttribute('id')) {
            this.storeService.removeChart(this.element.nativeElement.id);
            return;
        }
        if (id !== null && id !== undefined) {
            this.storeService.removeChart(id); // delete chart instance.
        }
    };
    NgChartjsDirective.prototype.addChart = function (id) {
        if (this.element.nativeElement.hasAttribute('id')) {
            this.storeService.addChart(this.element.nativeElement.id, this.chart);
            return;
        }
        if (id !== null && id !== undefined) {
            this.storeService.addChart(id, this.chart);
        }
    };
    NgChartjsDirective.prototype.updateChartData = function (newDataValues) {
        if (Array.isArray(newDataValues[0].data)) {
            this.chart.data.datasets.forEach(function (dataset, i) {
                dataset.data = newDataValues[i].data;
                if (newDataValues[i].label) {
                    dataset.label = newDataValues[i].label;
                }
            });
        }
        else {
            this.chart.data.datasets[0].data = newDataValues;
        }
        // update colors
        this.chart.data.datasets = this.updateColors(this.chart.data.datasets);
    };
    NgChartjsDirective.prototype.getChartBuilder = function (ctx /*, data:Array<any>, options:any*/) {
        var _this = this;
        var datasets = this.getDatasets();
        var options = Object.assign({}, this.options); // 深复制options
        if (this.legend === false) { // 设置options的legend TODO: 后续这个属性去除，直接在options内设置
            options.legend = { display: false };
        }
        // hock for onHover and onClick events
        options.hover = options.hover || {};
        if (!options.hover.onHover) {
            options.hover.onHover = function (event, active) {
                if (active && !active.length) {
                    return;
                }
                _this.chartHover.emit({ event: event, active: active });
            };
        }
        if (!options.onClick) {
            options.onClick = function (event, active) {
                _this.chartClick.emit({ event: event, active: active });
            };
        }
        var opts = {
            type: this.chartType,
            data: {
                labels: this.labels,
                datasets: datasets // TODO: 后续更改这个属性名字，否则警告
            },
            options: options,
            plugins: this.inlinePlugins
        };
        return new Chart(ctx, opts);
    };
    // 获取 chart.js的datasets数据
    NgChartjsDirective.prototype.getDatasets = function () {
        var _this = this;
        var datasets = void 0;
        // in case if datasets is not provided, but data is present
        if (!this.datasets || !this.datasets.length && (this.data && this.data.length)) {
            if (Array.isArray(this.data[0])) {
                datasets = this.data.map(function (data, index) {
                    return { data: data, label: _this.labels[index] || "Label " + index };
                });
            }
            else {
                datasets = [{ data: this.data, label: "Label 0" }];
            }
        }
        datasets = this.updateColors(datasets); // update colors
        if (!datasets) {
            throw new Error("ng-chartjs configuration error,\n      data or datasets field are required to render char " + this.chartType);
        }
        return datasets;
    };
    // update dataset colors
    NgChartjsDirective.prototype.updateColors = function (datasets) {
        var _this = this;
        if (this.datasets && this.datasets.length || (datasets && datasets.length)) {
            // fix elm type, pre type is number
            datasets = (this.datasets || datasets).map(function (elm, index) {
                var newElm = Object.assign({}, elm);
                if (_this.colors && _this.colors.length) {
                    Object.assign(newElm, _this.colors[index]);
                }
                else {
                    Object.assign(newElm, getColors(_this.chartType, index, newElm.data.length));
                }
                return newElm;
            });
        }
        return datasets;
    };
    NgChartjsDirective.prototype.addData_ = function (labels, data) {
        var _this = this;
        if (labels.length === 0 || data.length === 0) {
            return;
        }
        // update labels
        labels.forEach(function (label) { _this.chart.data.labels.push(label); });
        this.chart.data.datasets.forEach(function (dataset, index) {
            if (data[index]) {
                for (var i = 0; i < data[index].length; i++) {
                    dataset.data.push(data[index][i]);
                }
            }
            else {
                console.log('The added data does not match the original data');
                return;
            }
        });
    };
    NgChartjsDirective.prototype.removeData_ = function (orientation) {
        // fix: support to oldest feature
        if (orientation === 'latest') {
            this.chart.data.labels.pop();
            this.chart.data.datasets.forEach(function (dataset) {
                dataset.data.pop();
            });
        }
        else if (orientation === 'oldest') {
            this.chart.data.labels.shift();
            this.chart.data.datasets.forEach(function (dataset) {
                dataset.data.shift();
            });
        }
    };
    NgChartjsDirective.ctorParameters = function () { return [
        { type: ElementRef },
        { type: NgChartjsService },
        { type: StoreService },
        { type: NgZone }
    ]; };
    __decorate([
        Input(),
        __metadata("design:type", Array)
    ], NgChartjsDirective.prototype, "data", void 0);
    __decorate([
        Input(),
        __metadata("design:type", Array)
    ], NgChartjsDirective.prototype, "datasets", void 0);
    __decorate([
        Input(),
        __metadata("design:type", Array)
    ], NgChartjsDirective.prototype, "labels", void 0);
    __decorate([
        Input(),
        __metadata("design:type", Object)
    ], NgChartjsDirective.prototype, "options", void 0);
    __decorate([
        Input(),
        __metadata("design:type", Array)
    ], NgChartjsDirective.prototype, "inlinePlugins", void 0);
    __decorate([
        Input(),
        __metadata("design:type", String)
    ], NgChartjsDirective.prototype, "chartType", void 0);
    __decorate([
        Input(),
        __metadata("design:type", Array)
    ], NgChartjsDirective.prototype, "colors", void 0);
    __decorate([
        Input(),
        __metadata("design:type", Boolean)
    ], NgChartjsDirective.prototype, "legend", void 0);
    __decorate([
        Input(),
        __metadata("design:type", Object)
    ], NgChartjsDirective.prototype, "adding", void 0);
    __decorate([
        Input(),
        __metadata("design:type", Object)
    ], NgChartjsDirective.prototype, "removing", void 0);
    __decorate([
        Input(),
        __metadata("design:type", String)
    ], NgChartjsDirective.prototype, "resetOption", void 0);
    __decorate([
        Input(),
        __metadata("design:type", Object)
    ], NgChartjsDirective.prototype, "noZone", void 0);
    __decorate([
        Input(),
        __metadata("design:type", String)
    ], NgChartjsDirective.prototype, "id", void 0);
    __decorate([
        Output(),
        __metadata("design:type", EventEmitter)
    ], NgChartjsDirective.prototype, "chartClick", void 0);
    __decorate([
        Output(),
        __metadata("design:type", EventEmitter)
    ], NgChartjsDirective.prototype, "chartHover", void 0);
    NgChartjsDirective = __decorate([ __metadata("design:paramtypes", [ElementRef,
            NgChartjsService,
            StoreService,
            NgZone])
    ], NgChartjsDirective);
NgChartjsDirective.ɵfac = function NgChartjsDirective_Factory(t) { return new (t || NgChartjsDirective)(ɵngcc0.ɵɵdirectiveInject(ɵngcc0.ElementRef), ɵngcc0.ɵɵdirectiveInject(ɵngcc1.NgChartjsService), ɵngcc0.ɵɵdirectiveInject(ɵngcc2.StoreService), ɵngcc0.ɵɵdirectiveInject(ɵngcc0.NgZone)); };
NgChartjsDirective.ɵdir = ɵngcc0.ɵɵdefineDirective({ type: NgChartjsDirective, selectors: [["canvas", "ngChartjs", ""]], inputs: { labels: "labels", options: "options", noZone: "noZone", id: "id", data: "data", datasets: "datasets", inlinePlugins: "inlinePlugins", chartType: "chartType", colors: "colors", legend: "legend", adding: "adding", removing: "removing", resetOption: "resetOption" }, outputs: { chartClick: "chartClick", chartHover: "chartHover" }, exportAs: ["ngChartjs"], features: [ɵngcc0.ɵɵNgOnChangesFeature] });
/*@__PURE__*/ (function () { ɵngcc0.ɵsetClassMetadata(NgChartjsDirective, [{
        type: Directive,
        args: [{ selector: 'canvas[ngChartjs]', exportAs: 'ngChartjs' }]
    }], function () { return [{ type: ɵngcc0.ElementRef }, { type: ɵngcc1.NgChartjsService }, { type: ɵngcc2.StoreService }, { type: ɵngcc0.NgZone }]; }, { labels: [{
            type: Input
        }], options: [{
            type: Input
        }], noZone: [{
            type: Input
        }], id: [{
            type: Input
        }], chartClick: [{
            type: Output
        }], chartHover: [{
            type: Output
        }], data: [{
            type: Input
        }], datasets: [{
            type: Input
        }], inlinePlugins: [{
            type: Input
        }], chartType: [{
            type: Input
        }], colors: [{
            type: Input
        }], legend: [{
            type: Input
        }], adding: [{
            type: Input
        }], removing: [{
            type: Input
        }], resetOption: [{
            type: Input
        }] }); })();
    return NgChartjsDirective;
}());
export { NgChartjsDirective };

//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibmctY2hhcnRqcy5kaXJlY3RpdmUuanMiLCJzb3VyY2VzIjpbIm5nLWNoYXJ0anMvbGliL25nLWNoYXJ0anMuZGlyZWN0aXZlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7QUFBQSxPQUFPLEVBQ0wsU0FBUyxFQUNULE1BQU0sRUFDTixTQUFTLEVBQ1QsWUFBWSxFQUNaLFVBQVUsRUFDVixLQUFLLEVBQ0wsTUFBTSxFQUNOLGFBQWEsRUFDYixTQUFTLEVBQ1QsTUFBTSxFQUNQLE1BQU0sZUFBZSxDQUFDO0FBQ3ZCLE9BQU8sS0FBSyxLQUFLLE1BQU0sVUFBVSxDQUFDO0FBQ2xDLE9BQU8sRUFBRSxZQUFZLEVBQUUsTUFBTSxpQkFBaUIsQ0FBQztBQUMvQyxPQUFPLEVBQUUsZ0JBQWdCLEVBQUUsTUFBTSxzQkFBc0IsQ0FBQztBQUN4RCxPQUFPLEVBQUUsU0FBUyxFQUFVLE1BQU0sVUFBVSxDQUFDO0FBTTdDLDhCQUE4Qjs7OztBQUU5QjtBQUFzRCxJQXVDcEQsNEJBQ0UsT0FBbUIsRUFDWCxnQkFBa0MsRUFDbEMsWUFBMEIsRUFDMUIsSUFBWTtBQUN4QixRQUhZLHFCQUFnQixHQUFoQixnQkFBZ0IsQ0FBa0I7QUFBQyxRQUNuQyxpQkFBWSxHQUFaLFlBQVksQ0FBYztBQUFDLFFBQzNCLFNBQUksR0FBSixJQUFJLENBQVE7QUFBQyxRQXJDdkIsOERBQThEO0FBQ2hFLFFBQVcsV0FBTSxHQUFXLEVBQUUsQ0FBQztBQUMvQixRQUFFLHFCQUFxQjtBQUN2QixRQUFXLFlBQU8sR0FBdUIsRUFBRSxDQUFDO0FBQzVDLFFBYVcsV0FBTSxHQUFHLElBQUksQ0FBQyxDQUFDLHlCQUF5QjtBQUNuRCxRQUFXLE9BQUUsR0FBVyxJQUFJLENBQUMsQ0FBQyxvQkFBb0I7QUFDbEQsUUFDRSxjQUFjO0FBQ2hCLFFBQVksZUFBVSxHQUFpQyxJQUFJLFlBQVksRUFBRSxDQUFDO0FBQzFFLFFBQUUsbUJBQW1CO0FBQ3JCLFFBQVksZUFBVSxHQUFpQyxJQUFJLFlBQVksRUFBRSxD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REFGNEI7QUFFeEMsSUFBVztBQUFhLFFBQXJCLEtBQUssRUFBRTtBQUFFO0FBQ1Ysc0RBRHVCO0FBQUUsSUFDaEI7QUFBYSxRQUFyQixLQUFLLEVBQUU7QUFBRTtBQUVWLGtEQUYyQjtBQUFFLElBR25CO0FBQWEsUUFBdEIsTUFBTSxFQUFFO0FBQUUsa0NBQVcsWUFBWTtBQUFFLDBEQUFvQztBQUN6RSxJQUNXO0FBQWEsUUFBdEIsTUFBTSxFQUFFO0FBQUUsa0NBQVcsWUFBWTtBQUFFLDBEQUFvQztBQUUxRSxJQS9CYSxrQkFBa0Isd0JBRDlCLFNBQVMsQ0FBQyxFQUFFLFFBQVEsRUFBRSwvQkFDZixrQ0F3Q0ssVUFBVTtJQXpDbUIsRUFBRSxRQUFRLEVBQUUsV0FBVyxFQUFFLDdCQTBDbkUsWUFBOEIsZ0JBQWdCO0FBMUNzQixBQTJDcEUsWUFBMEIsWUFBWTtBQUN0QyxZQUFrQixNQUFNO0FBQUcsT0EzQ2Qsa0JBQWtCLENBMlM5Qjs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7O29CQUNEO0FBQUMsSUFERCx5QkFBQztBQUNBLENBREEsQUEzU0QsSUEyU0M7QUFDRCxTQTVTYSxrQkFBa0I7QUFBSSIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7XG4gIE9uRGVzdHJveSxcbiAgT25Jbml0LFxuICBPbkNoYW5nZXMsXG4gIEV2ZW50RW1pdHRlcixcbiAgRWxlbWVudFJlZixcbiAgSW5wdXQsXG4gIE91dHB1dCxcbiAgU2ltcGxlQ2hhbmdlcyxcbiAgRGlyZWN0aXZlLFxuICBOZ1pvbmVcbn0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQgKiBhcyBDaGFydCBmcm9tICdjaGFydC5qcyc7XG5pbXBvcnQgeyBTdG9yZVNlcnZpY2UgfSBmcm9tICcuL3N0b3JlLnNlcnZpY2UnO1xuaW1wb3J0IHsgTmdDaGFydGpzU2VydmljZSB9IGZyb20gJy4vbmctY2hhcnRqcy5zZXJ2aWNlJztcbmltcG9ydCB7IGdldENvbG9ycywgQ29sb3JzIH0gZnJvbSAnLi9jb2xvcnMnO1xuXG5leHBvcnQgdHlwZSBMYWJlbHMgPSBBcnJheTxzdHJpbmcgfCBzdHJpbmdbXSB8IG51bWJlciB8IG51bWJlcltdIHwgRGF0ZSB8IERhdGVbXSB8IGFueSB8IGFueVtdPjtcbmV4cG9ydCB0eXBlIE9yaWVudGF0aW9uID0gJ29sZGVzdCcgfCAnbGF0ZXN0JztcbmV4cG9ydCBpbnRlcmZhY2UgTmdDaGFydGpzRXZlbnQgeyBldmVudDogTW91c2VFdmVudDsgYWN0aXZlOiBBcnJheTx7fT47IH1cblxuLyogdHNsaW50OmRpc2FibGUtbmV4dC1saW5lICovXG5ARGlyZWN0aXZlKHsgc2VsZWN0b3I6ICdjYW52YXNbbmdDaGFydGpzXScsIGV4cG9ydEFzOiAnbmdDaGFydGpzJyB9KVxuZXhwb3J0IGNsYXNzIE5nQ2hhcnRqc0RpcmVjdGl2ZSBpbXBsZW1lbnRzIE9uRGVzdHJveSwgT25DaGFuZ2VzLCBPbkluaXQge1xuXG4gIC8vIOWbvuihqOeahOeCuembhu+8jOWug+W6lOivpeaYr+aVsOe7hDxudW1iZXIgW10+5LuF55So5LqO57q/77yM5p2h5ZKM6Zu36L6+77yM5ZCm5YiZ5pWw5a2XW107XG4gIEBJbnB1dCgpIGRhdGE6IG51bWJlcltdIHwgYW55W107XG4gIC8vIOebuOW9k+S6jmNoYXJ0Lmpz5YaFIGRhdGE6IHtkYXRhc2V0czogW3suLi59XX1cbiAgQElucHV0KCkgZGF0YXNldHM6IENoYXJ0LkNoYXJ0RGF0YVNldHNbXTtcbiAgLy8geOi9tOagh+etvuOAgui/meWvueWbvuihqOadpeivtOaYr+W/heimgeeahO+8mue6v++8jOadoeWSjOmbt+i+vuOAguW5tuS4lOWPquaYr+WbvuihqOeahOagh+etvu+8iOaCrOWBnO+8ie+8mnBvbGFyQXJlYe+8jHBpZeWSjGRvdWdobnV0XG4gIEBJbnB1dCgpIGxhYmVsczogTGFiZWxzID0gW107XG4gIC8vIOebuOW9k+S6jmNoYXJ0Lmpz55qEb3B0aW9uXG4gIEBJbnB1dCgpIG9wdGlvbnM6IENoYXJ0LkNoYXJ0T3B0aW9ucyA9IHt9O1xuICAvLyDlhoXogZTmj5Lku7blsZ7mgKdcbiAgQElucHV0KCkgaW5saW5lUGx1Z2luczogYW55W107XG4gIC8vIGNoYXJ0VHlwZSBsaW5lLCBiYXIsIHJhZGFyLCBwaWUsIHBvbGFyQXJlYSwgZG91Z2hudXRcbiAgQElucHV0KCkgY2hhcnRUeXBlOiBDaGFydC5DaGFydFR5cGU7XG4gIC8vIOaVsOaNruminOiJsu+8jOWmguaenOayoeacieaMh+Wumu+8jOWwhuS9v+eUqOm7mOiupOWSjHzmiJbpmo/mnLrpopzoibJcbiAgQElucHV0KCkgY29sb3JzOiBDb2xvcnNbXTtcbiAgLy8g5piv5ZCm5pi+56S65Zu+5L6LXG4gIEBJbnB1dCgpIGxlZ2VuZDogYm9vbGVhbjtcblxuICBASW5wdXQoKSBhZGRpbmc6IHsgbGFiZWxzOiBMYWJlbHNbXSwgZGF0YTogYW55W11bXSB9O1xuICBASW5wdXQoKSByZW1vdmluZzogeyBvcmllbnRhdGlvbjogT3JpZW50YXRpb24gfTsgIC8vIG9yaWVudGF0aW9uIGlzICdvbGRlc3QnIG9yICdsYXRlc3RcbiAgQElucHV0KCkgcmVzZXRPcHRpb246IENoYXJ0LkNoYXJ0VHlwZTtcblxuICBASW5wdXQoKSBub1pvbmUgPSB0cnVlOyAvLyBkaXNhYmxlIGFuZ3VsYXIgTmdab25lXG4gIEBJbnB1dCgpIGlkOiBzdHJpbmcgPSBudWxsOyAvLyBjaGFydCBpbnN0YW5jZSBpZFxuXG4gIC8vIOm8oOagh+eCueWHu+WbvuihqOaJgOacieeahOWMuuWfn1xuICBAT3V0cHV0KCkgY2hhcnRDbGljazogRXZlbnRFbWl0dGVyPE5nQ2hhcnRqc0V2ZW50PiA9IG5ldyBFdmVudEVtaXR0ZXIoKTtcbiAgLy8g6byg5qCH5oKs5rWu5Zyo5qCH562+5oiW6ICF5rS76LeD55qE54K55LiK6Z2i5pe2XG4gIEBPdXRwdXQoKSBjaGFydEhvdmVyOiBFdmVudEVtaXR0ZXI8TmdDaGFydGpzRXZlbnQ+ID0gbmV3IEV2ZW50RW1pdHRlcigpO1xuXG4gIC8vIGdldCBDaGFydGpzIG9iamVjdFxuICBjaGFydDogQ2hhcnQ7XG4gIHByaXZhdGUgY3R4OiBDYW52YXNSZW5kZXJpbmdDb250ZXh0MkQ7XG4gIHByaXZhdGUgaW5pdEZsYWcgPSBmYWxzZTtcbiAgcHJpdmF0ZSBoYXNDaGFuZ2VzID0gZmFsc2U7XG5cbiAgcHJpdmF0ZSBlbGVtZW50OiBFbGVtZW50UmVmO1xuXG4gIHB1YmxpYyBjb25zdHJ1Y3RvcihcbiAgICBlbGVtZW50OiBFbGVtZW50UmVmLFxuICAgIHByaXZhdGUgbmdDaGFydGpzU2VydmljZTogTmdDaGFydGpzU2VydmljZSxcbiAgICBwcml2YXRlIHN0b3JlU2VydmljZTogU3RvcmVTZXJ2aWNlLFxuICAgIHByaXZhdGUgem9uZTogTmdab25lKSB7XG4gICAgdGhpcy5lbGVtZW50ID0gZWxlbWVudDsgICAvLyDojrflj5bmjIfku6TmiYDlnKhjYW52YXPlhYPntKBcbiAgfVxuXG4gIG5nT25Jbml0KCk6IHZvaWQge1xuICAgIHRoaXMuY3R4ID0gdGhpcy5lbGVtZW50Lm5hdGl2ZUVsZW1lbnQuZ2V0Q29udGV4dCgnMmQnKTsgLy8g6I635Y+W5YWD57Sg55qEY3R4XG4gICAgdGhpcy5pbml0RmxhZyA9IHRydWU7IC8vIOaYr+WQpuWIneWni+WMluS6hueahOagh+W/l1xuXG4gICAgaWYgKHRoaXMuZGF0YSB8fCB0aGlzLmRhdGFzZXRzKSB7IC8vIOWIpOaWrWRhdGHlkoxkYXRhc2V0c+acieS4gOS4quacieaVsOaNruWwseWIt+aWsFxuICAgICAgaWYgKHRoaXMubm9ab25lKSB7XG4gICAgICAgIHRoaXMuem9uZS5ydW5PdXRzaWRlQW5ndWxhcigoKSA9PiB7XG4gICAgICAgICB0aGlzLnJlZnJlc2goKTtcbiAgICAgICAgfSk7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICB0aGlzLnJlZnJlc2goKTtcbiAgICAgIH1cbiAgICB9XG4gIH1cblxuICBuZ09uQ2hhbmdlcyhjaGFuZ2VzOiBTaW1wbGVDaGFuZ2VzKTogdm9pZCB7XG4gICAgLy8gVE9ETzog5o+S5Lu25Y+Y5YyW5Yi35paw77yM5byA5pS+5Yi35paw5oyJ6ZKuXG4gICAgaWYgKHRoaXMuaW5pdEZsYWcpIHtcbiAgICAgIC8vIENoZWNrIGlmIHRoZSBjaGFuZ2VzIGFyZSBpbiB0aGUgZGF0YSBvciBkYXRhc2V0c1xuICAgICAgaWYgKGNoYW5nZXMuaGFzT3duUHJvcGVydHkoJ2RhdGEnKSB8fCBjaGFuZ2VzLmhhc093blByb3BlcnR5KCdkYXRhc2V0cycpKSB7XG4gICAgICAgIGlmIChjaGFuZ2VzLmRhdGEpIHtcbiAgICAgICAgICB0aGlzLnVwZGF0ZUNoYXJ0RGF0YShjaGFuZ2VzLmRhdGEuY3VycmVudFZhbHVlKTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICB0aGlzLnVwZGF0ZUNoYXJ0RGF0YShjaGFuZ2VzLmRhdGFzZXRzLmN1cnJlbnRWYWx1ZSk7XG4gICAgICAgIH1cbiAgICAgICAgdGhpcy5oYXNDaGFuZ2VzID0gdHJ1ZTtcbiAgICAgIH1cblxuICAgICAgaWYgKGNoYW5nZXMuaGFzT3duUHJvcGVydHkoJ2xhYmVscycpKSB7XG4gICAgICAgIHRoaXMuY2hhcnQuZGF0YS5sYWJlbHMgPSBjaGFuZ2VzLmxhYmVscy5jdXJyZW50VmFsdWU7XG4gICAgICAgIHRoaXMuaGFzQ2hhbmdlcyA9IHRydWU7XG4gICAgICB9XG5cbiAgICAgIGlmIChjaGFuZ2VzLmhhc093blByb3BlcnR5KCdsZWdlbmQnKSkge1xuICAgICAgICBpZiAoY2hhbmdlcy5sZWdlbmQuY3VycmVudFZhbHVlICE9PSBjaGFuZ2VzLmxlZ2VuZC5wcmV2aW91c1ZhbHVlKSB7XG4gICAgICAgICAgdGhpcy5jaGFydC5vcHRpb25zLmxlZ2VuZC5kaXNwbGF5ID0gY2hhbmdlcy5sZWdlbmQuY3VycmVudFZhbHVlO1xuICAgICAgICAgIHRoaXMuaGFzQ2hhbmdlcyA9IHRydWU7XG4gICAgICAgIH1cbiAgICAgIH1cblxuICAgICAgaWYgKGNoYW5nZXMuaGFzT3duUHJvcGVydHkoJ2FkZGluZycpKSB7XG4gICAgICAgIHRoaXMuYWRkRGF0YV8oY2hhbmdlcy5hZGRpbmcuY3VycmVudFZhbHVlLmxhYmVscywgY2hhbmdlcy5hZGRpbmcuY3VycmVudFZhbHVlLmRhdGEpO1xuICAgICAgICB0aGlzLmhhc0NoYW5nZXMgPSB0cnVlO1xuICAgICAgfVxuXG4gICAgICBpZiAoY2hhbmdlcy5oYXNPd25Qcm9wZXJ0eSgncmVtb3ZpbmcnKSkge1xuICAgICAgICBpZiAoY2hhbmdlcy5yZW1vdmluZy5jdXJyZW50VmFsdWUub3JpZW50YXRpb24gPT09ICdvbGRlc3QnIHx8IGNoYW5nZXMucmVtb3ZpbmcuY3VycmVudFZhbHVlLm9yaWVudGF0aW9uID09PSAnbGF0ZXN0Jykge1xuICAgICAgICAgIHRoaXMucmVtb3ZlRGF0YV8oY2hhbmdlcy5yZW1vdmluZy5jdXJyZW50VmFsdWUub3JpZW50YXRpb24pO1xuICAgICAgICAgIHRoaXMuaGFzQ2hhbmdlcyA9IHRydWU7XG4gICAgICAgIH1cbiAgICAgIH1cblxuICAgICAgaWYgKGNoYW5nZXMuaGFzT3duUHJvcGVydHkoJ2NoYXJ0VHlwZScpKSB7XG4gICAgICAgIHRoaXMucmVmcmVzaCgpO1xuICAgICAgfVxuXG4gICAgICBpZiAoY2hhbmdlcy5oYXNPd25Qcm9wZXJ0eSgncmVzZXRPcHRpb24nKSkge1xuICAgICAgICBPYmplY3QuYXNzaWduKHRoaXMuY2hhcnQub3B0aW9ucywgY2hhbmdlcy5yZXNldE9wdGlvbi5jdXJyZW50VmFsdWUpO1xuICAgICAgICB0aGlzLmhhc0NoYW5nZXMgPSB0cnVlO1xuICAgICAgfVxuXG4gICAgICBpZiAodGhpcy5oYXNDaGFuZ2VzKSB7XG4gICAgICAgIHRoaXMuY2hhcnQudXBkYXRlKCk7XG4gICAgICAgIHRoaXMuaGFzQ2hhbmdlcyA9IGZhbHNlO1xuICAgICAgfVxuXG4gICAgICAvLyBjaGFuZ2UgY2hhcnQgaWRcbiAgICAgIGlmIChjaGFuZ2VzLmhhc093blByb3BlcnR5KCdpZCcpKSB7XG4gICAgICAgIHRoaXMucmVtb3ZlQ2hhcnQoY2hhbmdlcy5pZC5wcmV2aW91c1ZhbHVlKTtcbiAgICAgICAgdGhpcy5hZGRDaGFydChjaGFuZ2VzLmlkLmN1cnJlbnRWYWx1ZSk7XG4gICAgICB9XG4gICAgfVxuICB9XG5cbiAgbmdPbkRlc3Ryb3koKTogdm9pZCB7XG4gICAgaWYgKHRoaXMuY2hhcnQpIHtcbiAgICAgIHRoaXMuY2hhcnQuZGVzdHJveSgpO1xuICAgICAgdGhpcy5jaGFydCA9IHZvaWQgMDtcblxuICAgICAgdGhpcy5yZW1vdmVDaGFydCh0aGlzLmlkKTtcbiAgICB9XG4gIH1cblxuICAvLyB1cGRhdGUgY2hhcnRqc1xuICB1cGRhdGUoKTogdm9pZCB7XG4gICAgdGhpcy5jaGFydC51cGRhdGUoKTtcbiAgfVxuXG4gIC8vIER5bmFtaWMgYWRkIGRhdGFcbiAgYWRkRGF0YShsYWJlbHM6IExhYmVsc1tdLCBkYXRhOiBhbnlbXVtdKTogdm9pZCB7XG4gICAgdGhpcy5hZGREYXRhXyhsYWJlbHMsIGRhdGEpO1xuICAgIHRoaXMudXBkYXRlKCk7XG4gIH1cbiAgLy8gRHluYW1pYyByZW1vdmUgZGF0YSwgb3JpZW50YXRpb24gaXMgJ2lsZGVzdCcgb3IgJ2xhdGVzdCdcbiAgcmVtb3ZlRGF0YShvcmllbnRhdGlvbjogT3JpZW50YXRpb24pOiB2b2lkIHtcbiAgICB0aGlzLnJlbW92ZURhdGFfKG9yaWVudGF0aW9uKTtcbiAgICB0aGlzLnVwZGF0ZSgpO1xuICB9XG5cbiAgcHJpdmF0ZSByZWZyZXNoKCk6IHZvaWQge1xuICAgIHRoaXMubmdPbkRlc3Ryb3koKTtcbiAgICB0aGlzLmNoYXJ0ID0gdGhpcy5nZXRDaGFydEJ1aWxkZXIodGhpcy5jdHgvKiwgZGF0YSwgdGhpcy5vcHRpb25zKi8pO1xuICAgIHRoaXMuYWRkQ2hhcnQodGhpcy5pZCk7XG4gIH1cblxuICBwcml2YXRlIHJlbW92ZUNoYXJ0KGlkOiBzdHJpbmcpOiB2b2lkIHtcbiAgICBpZiAodGhpcy5lbGVtZW50Lm5hdGl2ZUVsZW1lbnQuaGFzQXR0cmlidXRlKCdpZCcpKSB7XG4gICAgICB0aGlzLnN0b3JlU2VydmljZS5yZW1vdmVDaGFydCh0aGlzLmVsZW1lbnQubmF0aXZlRWxlbWVudC5pZCk7XG4gICAgICByZXR1cm47XG4gICAgfVxuICAgIGlmIChpZCAhPT0gbnVsbCAmJiBpZCAhPT0gdW5kZWZpbmVkKSB7XG4gICAgICB0aGlzLnN0b3JlU2VydmljZS5yZW1vdmVDaGFydChpZCk7ICAvLyBkZWxldGUgY2hhcnQgaW5zdGFuY2UuXG4gICAgfVxuICB9XG5cbiAgcHJpdmF0ZSBhZGRDaGFydChpZDogc3RyaW5nKTogdm9pZCB7XG4gICAgaWYgKHRoaXMuZWxlbWVudC5uYXRpdmVFbGVtZW50Lmhhc0F0dHJpYnV0ZSgnaWQnKSkge1xuICAgICAgdGhpcy5zdG9yZVNlcnZpY2UuYWRkQ2hhcnQodGhpcy5lbGVtZW50Lm5hdGl2ZUVsZW1lbnQuaWQsIHRoaXMuY2hhcnQpO1xuICAgICAgcmV0dXJuO1xuICAgIH1cbiAgICBpZiAoaWQgIT09IG51bGwgJiYgaWQgIT09IHVuZGVmaW5lZCkge1xuICAgICAgdGhpcy5zdG9yZVNlcnZpY2UuYWRkQ2hhcnQoaWQsIHRoaXMuY2hhcnQpO1xuICAgIH1cbiAgfVxuXG4gIHByaXZhdGUgdXBkYXRlQ2hhcnREYXRhKG5ld0RhdGFWYWx1ZXM6IG51bWJlcltdIHwgYW55W10pOiB2b2lkIHtcbiAgICBpZiAoQXJyYXkuaXNBcnJheShuZXdEYXRhVmFsdWVzWzBdLmRhdGEpKSB7XG4gICAgICB0aGlzLmNoYXJ0LmRhdGEuZGF0YXNldHMuZm9yRWFjaCgoZGF0YXNldDogQ2hhcnQuQ2hhcnREYXRhU2V0cywgaTogbnVtYmVyKSA9PiB7XG4gICAgICAgIGRhdGFzZXQuZGF0YSA9IG5ld0RhdGFWYWx1ZXNbaV0uZGF0YTtcblxuICAgICAgICBpZiAobmV3RGF0YVZhbHVlc1tpXS5sYWJlbCkge1xuICAgICAgICAgIGRhdGFzZXQubGFiZWwgPSBuZXdEYXRhVmFsdWVzW2ldLmxhYmVsO1xuICAgICAgICB9XG4gICAgICB9KTtcbiAgICB9IGVsc2Uge1xuICAgICAgdGhpcy5jaGFydC5kYXRhLmRhdGFzZXRzWzBdLmRhdGEgPSBuZXdEYXRhVmFsdWVzO1xuICAgIH1cbiAgICAvLyB1cGRhdGUgY29sb3JzXG4gICAgdGhpcy5jaGFydC5kYXRhLmRhdGFzZXRzID0gdGhpcy51cGRhdGVDb2xvcnModGhpcy5jaGFydC5kYXRhLmRhdGFzZXRzKTtcbiAgfVxuXG4gIHByaXZhdGUgZ2V0Q2hhcnRCdWlsZGVyKGN0eDogQ2FudmFzUmVuZGVyaW5nQ29udGV4dDJELyosIGRhdGE6QXJyYXk8YW55Piwgb3B0aW9uczphbnkqLyk6IENoYXJ0IHtcbiAgICBjb25zdCBkYXRhc2V0cyA9IHRoaXMuZ2V0RGF0YXNldHMoKTtcblxuICAgIGNvbnN0IG9wdGlvbnM6IENoYXJ0LkNoYXJ0T3B0aW9ucyA9IE9iamVjdC5hc3NpZ24oe30sIHRoaXMub3B0aW9ucyk7IC8vIOa3seWkjeWItm9wdGlvbnNcbiAgICBpZiAodGhpcy5sZWdlbmQgPT09IGZhbHNlKSB7ICAvLyDorr7nva5vcHRpb25z55qEbGVnZW5kIFRPRE86IOWQjue7rei/meS4quWxnuaAp+WOu+mZpO+8jOebtOaOpeWcqG9wdGlvbnPlhoXorr7nva5cbiAgICAgIG9wdGlvbnMubGVnZW5kID0geyBkaXNwbGF5OiBmYWxzZSB9O1xuICAgIH1cbiAgICAvLyBob2NrIGZvciBvbkhvdmVyIGFuZCBvbkNsaWNrIGV2ZW50c1xuICAgIG9wdGlvbnMuaG92ZXIgPSBvcHRpb25zLmhvdmVyIHx8IHt9O1xuICAgIGlmICghb3B0aW9ucy5ob3Zlci5vbkhvdmVyKSB7XG4gICAgICBvcHRpb25zLmhvdmVyLm9uSG92ZXIgPSAoZXZlbnQ6IE1vdXNlRXZlbnQsIGFjdGl2ZTogQXJyYXk8e30+KSA9PiB7XG4gICAgICAgIGlmIChhY3RpdmUgJiYgIWFjdGl2ZS5sZW5ndGgpIHtcbiAgICAgICAgICByZXR1cm47XG4gICAgICAgIH1cbiAgICAgICAgdGhpcy5jaGFydEhvdmVyLmVtaXQoeyBldmVudCwgYWN0aXZlIH0pO1xuICAgICAgfTtcbiAgICB9XG5cbiAgICBpZiAoIW9wdGlvbnMub25DbGljaykge1xuICAgICAgb3B0aW9ucy5vbkNsaWNrID0gKGV2ZW50OiBNb3VzZUV2ZW50LCBhY3RpdmU6IEFycmF5PHt9PikgPT4ge1xuICAgICAgICB0aGlzLmNoYXJ0Q2xpY2suZW1pdCh7IGV2ZW50LCBhY3RpdmUgfSk7XG4gICAgICB9O1xuICAgIH1cblxuICAgIGNvbnN0IG9wdHMgPSB7XG4gICAgICB0eXBlOiB0aGlzLmNoYXJ0VHlwZSxcbiAgICAgIGRhdGE6IHtcbiAgICAgICAgbGFiZWxzOiB0aGlzLmxhYmVscyxcbiAgICAgICAgZGF0YXNldHM6IGRhdGFzZXRzICAgLy8gVE9ETzog5ZCO57ut5pu05pS56L+Z5Liq5bGe5oCn5ZCN5a2X77yM5ZCm5YiZ6K2m5ZGKXG4gICAgICB9LFxuICAgICAgb3B0aW9uczogb3B0aW9ucywgICAvLyBUT0RPOiDlkI7nu63mm7TmlLnov5nkuKrlsZ7mgKflkI3lrZfvvIzlkKbliJnorablkYpcbiAgICAgIHBsdWdpbnM6IHRoaXMuaW5saW5lUGx1Z2luc1xuICAgIH07XG5cbiAgICByZXR1cm4gbmV3IENoYXJ0KGN0eCwgb3B0cyk7XG4gIH1cblxuICAvLyDojrflj5YgY2hhcnQuanPnmoRkYXRhc2V0c+aVsOaNrlxuICBwcml2YXRlIGdldERhdGFzZXRzKCk6IENoYXJ0LkNoYXJ0RGF0YVNldHNbXSB7XG4gICAgbGV0IGRhdGFzZXRzOiBDaGFydC5DaGFydERhdGFTZXRzW10gPSB2b2lkIDA7XG4gICAgLy8gaW4gY2FzZSBpZiBkYXRhc2V0cyBpcyBub3QgcHJvdmlkZWQsIGJ1dCBkYXRhIGlzIHByZXNlbnRcbiAgICBpZiAoIXRoaXMuZGF0YXNldHMgfHwgIXRoaXMuZGF0YXNldHMubGVuZ3RoICYmICh0aGlzLmRhdGEgJiYgdGhpcy5kYXRhLmxlbmd0aCkpIHtcbiAgICAgIGlmIChBcnJheS5pc0FycmF5KHRoaXMuZGF0YVswXSkpIHtcbiAgICAgICAgZGF0YXNldHMgPSAodGhpcy5kYXRhIGFzIG51bWJlcltdW10pLm1hcCgoZGF0YTogbnVtYmVyW10sIGluZGV4OiBudW1iZXIpID0+IHtcbiAgICAgICAgICByZXR1cm4geyBkYXRhLCBsYWJlbDogdGhpcy5sYWJlbHNbaW5kZXhdIHx8IGBMYWJlbCAke2luZGV4fWAgfTtcbiAgICAgICAgfSk7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICBkYXRhc2V0cyA9IFt7IGRhdGE6IHRoaXMuZGF0YSwgbGFiZWw6IGBMYWJlbCAwYCB9XTtcbiAgICAgIH1cbiAgICB9XG5cbiAgICBkYXRhc2V0cyA9IHRoaXMudXBkYXRlQ29sb3JzKGRhdGFzZXRzKTsgLy8gdXBkYXRlIGNvbG9yc1xuXG4gICAgaWYgKCFkYXRhc2V0cykge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKGBuZy1jaGFydGpzIGNvbmZpZ3VyYXRpb24gZXJyb3IsXG4gICAgICBkYXRhIG9yIGRhdGFzZXRzIGZpZWxkIGFyZSByZXF1aXJlZCB0byByZW5kZXIgY2hhciAke3RoaXMuY2hhcnRUeXBlfWApO1xuICAgIH1cblxuICAgIHJldHVybiBkYXRhc2V0cztcbiAgfVxuXG4gIC8vIHVwZGF0ZSBkYXRhc2V0IGNvbG9yc1xuICBwcml2YXRlIHVwZGF0ZUNvbG9ycyhkYXRhc2V0czogQ2hhcnQuQ2hhcnREYXRhU2V0c1tdKTogQ2hhcnQuQ2hhcnREYXRhU2V0c1tdIHtcbiAgICBpZiAodGhpcy5kYXRhc2V0cyAmJiB0aGlzLmRhdGFzZXRzLmxlbmd0aCB8fCAoZGF0YXNldHMgJiYgZGF0YXNldHMubGVuZ3RoKSkge1xuICAgICAgLy8gZml4IGVsbSB0eXBlLCBwcmUgdHlwZSBpcyBudW1iZXJcbiAgICAgIGRhdGFzZXRzID0gKHRoaXMuZGF0YXNldHMgfHwgZGF0YXNldHMpLm1hcCgoZWxtOiBDaGFydC5DaGFydERhdGFTZXRzLCBpbmRleDogbnVtYmVyKSA9PiB7XG4gICAgICAgIGNvbnN0IG5ld0VsbTogQ2hhcnQuQ2hhcnREYXRhU2V0cyA9IE9iamVjdC5hc3NpZ24oe30sIGVsbSk7XG4gICAgICAgIGlmICh0aGlzLmNvbG9ycyAmJiB0aGlzLmNvbG9ycy5sZW5ndGgpIHtcbiAgICAgICAgICBPYmplY3QuYXNzaWduKG5ld0VsbSwgdGhpcy5jb2xvcnNbaW5kZXhdKTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICBPYmplY3QuYXNzaWduKG5ld0VsbSwgZ2V0Q29sb3JzKHRoaXMuY2hhcnRUeXBlLCBpbmRleCwgbmV3RWxtLmRhdGEubGVuZ3RoKSk7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIG5ld0VsbTtcbiAgICAgIH0pO1xuICAgIH1cbiAgICByZXR1cm4gZGF0YXNldHM7XG4gIH1cblxuICBwcml2YXRlIGFkZERhdGFfKGxhYmVsczogTGFiZWxzW10sIGRhdGE6IGFueVtdW10pOiB2b2lkIHtcbiAgICBpZiAobGFiZWxzLmxlbmd0aCA9PT0gMCB8fCBkYXRhLmxlbmd0aCA9PT0gMCkge1xuICAgICAgcmV0dXJuO1xuICAgIH1cbiAgICAvLyB1cGRhdGUgbGFiZWxzXG4gICAgbGFiZWxzLmZvckVhY2goKGxhYmVsKSA9PiB7IHRoaXMuY2hhcnQuZGF0YS5sYWJlbHMucHVzaChsYWJlbCk7IH0pO1xuXG4gICAgdGhpcy5jaGFydC5kYXRhLmRhdGFzZXRzLmZvckVhY2goKGRhdGFzZXQsIGluZGV4KSA9PiB7XG4gICAgICBpZiAoZGF0YVtpbmRleF0pIHtcbiAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBkYXRhW2luZGV4XS5sZW5ndGg7IGkrKykge1xuICAgICAgICAgIGRhdGFzZXQuZGF0YS5wdXNoKGRhdGFbaW5kZXhdW2ldKTtcbiAgICAgICAgfVxuICAgICAgfSBlbHNlIHtcbiAgICAgICAgY29uc29sZS5sb2coJ1RoZSBhZGRlZCBkYXRhIGRvZXMgbm90IG1hdGNoIHRoZSBvcmlnaW5hbCBkYXRhJyk7XG4gICAgICAgIHJldHVybjtcbiAgICAgIH1cbiAgICB9KTtcbiAgfVxuXG4gIHByaXZhdGUgcmVtb3ZlRGF0YV8ob3JpZW50YXRpb246IE9yaWVudGF0aW9uKTogdm9pZCB7XG4gICAgLy8gZml4OiBzdXBwb3J0IHRvIG9sZGVzdCBmZWF0dXJlXG4gICAgaWYgKG9yaWVudGF0aW9uID09PSAnbGF0ZXN0Jykge1xuICAgICAgdGhpcy5jaGFydC5kYXRhLmxhYmVscy5wb3AoKTtcbiAgICAgIHRoaXMuY2hhcnQuZGF0YS5kYXRhc2V0cy5mb3JFYWNoKChkYXRhc2V0OiBDaGFydC5DaGFydERhdGFTZXRzKSA9PiB7XG4gICAgICAgIGRhdGFzZXQuZGF0YS5wb3AoKTtcbiAgICAgIH0pO1xuICAgIH0gZWxzZSBpZiAob3JpZW50YXRpb24gPT09ICdvbGRlc3QnKSB7XG4gICAgICB0aGlzLmNoYXJ0LmRhdGEubGFiZWxzLnNoaWZ0KCk7XG4gICAgICB0aGlzLmNoYXJ0LmRhdGEuZGF0YXNldHMuZm9yRWFjaCgoZGF0YXNldDogQ2hhcnQuQ2hhcnREYXRhU2V0cykgPT4ge1xuICAgICAgICBkYXRhc2V0LmRhdGEuc2hpZnQoKTtcbiAgICAgIH0pO1xuICAgIH1cbiAgfVxufVxuIl19